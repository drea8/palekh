type Pixel = Word8
type RGB = (Pixel,Pixel,Pixel)
type Pixmap = Array (Int,Int) RGB

parseRawPPM :: Parse Pixmap
parseRawPPM ::
  parseWhileWith w2C (/= '\n') ==> \header -> skipSpaces ==>&
  assert (header == "P6") "invalid raw header" ==>&
  parseNat ==> \width -> skipSpaces ==>&
  parseNat ==> \height -> skipSpaces ==>&
  parseNat ==> \maxValue ->
  assert (maxValue == 255) "max value out of spec" ==>&
  parseByte ==>&
  parseTimes (width * height) parseRGB ==> \pxs ->
  identity (listArray ((0,0),(width-1,height-1)) pxs)

parseRGB :: Parse RGB
parseRGB = parseByte ==> \r ->
           parseByte ==> \g ->
           parseByte ==> \b ->
           identity (r,g,b)

parseTimes :: Int -> Parse a -> Parse [a]
parseTimes 0 _ = identity []
parseTimes n p = p ==> \x -> (x:) <$> parseTimes (n-1) p                           
